schema: '2.0'
stages:
  set_up_diffusers:
    cmd: "git clone --depth 1 --branch v0.14.0 https://github.com/huggingface/diffusers.git\
      \ diffusers\npip3.10 install -r \"diffusers/examples/dreambooth/requirements.txt\"\
      \naccelerate config default\n"
    outs:
    - path: diffusers
      md5: 24d2dc4cd0e74c32b967fbc7fbc1c25f.dir
      size: 5998474
      nfiles: 545
  scrape_pokemon_images:
    cmd: python3 src/scrape_pokemon_images.py --params params.yaml
    deps:
    - path: src/scrape_pokemon_images.py
      md5: 9b2c189c9af8b0cff17f9e5d28af2a52
      size: 1266
    outs:
    - path: data/external/pokemon
      md5: 6b41f549b3211b04a1597c81fc4be6c6.dir
      size: 130512085
      nfiles: 1008
  download_pokemon_stats:
    cmd: kaggle datasets download -d brdata/complete-pokemon-dataset-gen-iiv -f Pokedex_Cleaned.csv
      -p data/external/
    outs:
    - path: data/external/Pokedex_Cleaned.csv
      md5: eb037b3ce0411f8c0d47483918114b33
      size: 58035
  resize_pokemon_images:
    cmd: python3 src/resize_pokemon_images.py --params params.yaml
    deps:
    - path: data/external/Pokedex_Cleaned.csv
      md5: eb037b3ce0411f8c0d47483918114b33
      size: 58035
    - path: data/external/pokemon
      md5: 6b41f549b3211b04a1597c81fc4be6c6.dir
      size: 130512085
      nfiles: 1008
    - path: src/resize_pokemon_images.py
      md5: 506d0d3c5d554c2eba0597730cb1dd4c
      size: 2732
    params:
      params.yaml:
        base:
          train_pokemon_type: all
        data_etl:
          external_data_path: data/external/
          train_data_path: data/processed/pokemon
    outs:
    - path: data/processed/pokemon
      md5: a26f62405388119e770a1f2e710c3535.dir
      size: 146096519
      nfiles: 1003
  train_lora:
    cmd: "accelerate launch --mps \"diffusers/examples/dreambooth/train_dreambooth_lora.py\"\
      \ --pretrained_model_name_or_path=runwayml/stable-diffusion-v1-5 --instance_data_dir=data/processed/pokemon\
      \ --output_dir=models/pkmnlora --instance_prompt='a pkmnlora pokemon' --resolution=512\
      \ --train_batch_size=1 --gradient_accumulation_steps=1 --checkpointing_steps=500\
      \ --learning_rate=0.0001 --lr_scheduler='cosine' --lr_warmup_steps=0 --max_train_steps=15000\
      \ --seed=1337\n"
    deps:
    - path: data/processed/pokemon
      md5: a26f62405388119e770a1f2e710c3535.dir
      size: 146096519
      nfiles: 1003
    - path: diffusers
      md5: 24d2dc4cd0e74c32b967fbc7fbc1c25f.dir
      size: 5998474
      nfiles: 545
    params:
      params.yaml:
        data_etl:
          external_data_path: data/external/
          train_data_path: data/processed/pokemon
        train_lora:
          seed: 1337
          model_directory: models
          base_model: runwayml/stable-diffusion-v1-5
          lora_path: models/pkmnlora
          learning_rate: 0.0001
          max_train_steps: 15000
    outs:
    - path: models/pkmnlora
      md5: 525eec90862c7e30388dedf08b58cb1f.dir
      size: 398219967
      nfiles: 121
  generate_text_to_image:
    cmd: python3 src/generate_text_to_image.py --params params.yaml
    deps:
    - path: models/pkmnlora
      md5: 525eec90862c7e30388dedf08b58cb1f.dir
      size: 398219967
      nfiles: 121
    - path: src/generate_text_to_image.py
      md5: 94c0a397b1801c0dca7932262aacc942
      size: 2991
    params:
      params.yaml:
        generate_text_to_image:
          seed: 3000
          num_inference_steps: 35
          batch_size: 1
          batch_count: 20
          prompt: a pkmnlora pokemon
          negative_prompt: ''
          output_directory: outputs
          use_lora: true
        train_lora:
          seed: 1337
          model_directory: models
          base_model: runwayml/stable-diffusion-v1-5
          lora_path: models/pkmnlora
          learning_rate: 0.0001
          max_train_steps: 15000
    outs:
    - path: outputs
      md5: b4329d7a9a6048897bf163871f462a99.dir
      size: 6196820
      nfiles: 20
